<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Home Ventilation Control</title>
<style>
input {
    width: 4em;
}
input.ttl {
    width: 4.5em;
}
.box-row {
    display: flex;
    flex-wrap: wrap;
}
.rpm-grid label {
    text-align: right;
}
.rpm-grid {
    display: grid;
    grid-template-areas: 'i-off b' 'i-1 i-2' 'i-3 i-4' 'i-5 i-6' 'i-7 i-8';
    grid-gap: 0.5em;
}
.rpm-grid button {
    grid-area: b;
}

@media (min-width: 32em) {
    fieldset {
        min-width: 30em;
    }
    .rpm-grid {
        display: grid;
        grid-template-areas: 'i-off b b b' 'i-1 i-2 i-3 i-4' 'i-5 i-6 i-7 i-8';
        grid-gap: 0.5em;
    }
}
</style>
<body>
<h1>Home Ventilation Control</h1>

<fieldset>
<legend>Status</legend>
<pre id="txt">Status...</pre>
</fieldset>

<div class="box-row">
<form class="json">
<fieldset>
<legend>Main fan Wi-Fi map</legend>
<p><textarea name="wifi_0" class="points" rows="5" cols="15"></textarea></p>
<label><input type="number" name="wifi_0_ttl" class="ttl" data-multiplier="60000" min="1" max="14400" value="60" required> min</label>
<button type="submit">send</button>
</fieldset>
</form>

<form class="json">
<fieldset>
<legend>Kitchen hood Wi-Fi map</legend>
<p><textarea name="wifi_1" class="points" rows="5" cols="15"></textarea></p>
<label><input type="number" name="wifi_1_ttl" class="ttl" data-multiplier="60000" min="1" max="14400" value="60" required> min</label>
<button type="submit">send</button>
</fieldset>
</form>
</div>

<div class="box-row">
<form name="ir_speeds">
<fieldset>
<legend>Kitchen hood RPM for IR codes</legend>
<p class="rpm-grid" data-inputs="off,1,2,3,4"><button type="submit">save</button></p>
</fieldset>
</form>

<form name="hood_speeds">
<fieldset>
<legend>Kitchen hood RPM for buttons</legend>
<p class="rpm-grid" data-inputs="off,1,2,3,4,5,6,7,8"><button type="submit">save</button></p>
<p>Notice: the hood uses only 4 of 8 settings.</p>
</fieldset>
</form>
</div>

<script>
const update = async () => {
    document.getElementById("txt").textContent = await (await fetch("?txt")).text();
};
const setnum = (input, value) => {
    input.value = value / (+input.dataset.multiplier || 1);
};
const reload = async () => {
    let json = await (await fetch("?json")).json();
    const points = t => t.map(xy => `${xy[0]}\t${xy[1]}\n`).join("");
    for (let i of ["0", "1"]) {
        document.getElementsByName("wifi_" + i)[0].value = points(json[i]["wifi"]["points"]);
        setnum(document.getElementsByName("wifi_" + i + "_ttl")[0], json[i]["wifi"]["ttl"]);
    }
};
const post = data => {
    fetch("?json-post", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    }).then(update);
};
document.querySelectorAll("[data-inputs]").forEach(form => {
    form.dataset.inputs.split(",").map(i => {
        form.innerHTML += "<label style='grid-area: i-" + i + "'>" + i + ": <input type='number' min='0' max='9999' required></label>";
    });
});
document.querySelectorAll("form").forEach(form => {
    form.addEventListener("submit", e => {
        e.preventDefault();
        if (!form.reportValidity()) {
            return;
        }
        let data = {};
        if (!form.classList.contains("json")) {
            data[form.name] = Array.from(form.querySelectorAll("input")).map(input => input.value).join(",");
            post(data);
            return;
        }
        Array.from(form.querySelectorAll("input, textarea")).forEach(input => {
            let value = input.value;
            if (input.type == "number") {
                value = +value;
                if (+input.dataset.multiplier) {
                    value *= +input.dataset.multiplier;
                }
            }
            if (input.classList.contains("points")) {
                value = value.match(/(-?\d+)/g).map(x => +x);
                value = value.map((x, i) => [value[i-1], x]).filter((x, i) => i % 2 == 1);
            }
            data[input.name] = value;
        });
        post(data);
    });
});
const init = (name, values) => {
    let inputs = document.forms[name].querySelectorAll("input");
    values.forEach((x, i) => inputs[i].value = x);
};
window.addEventListener("load", async () => {
    update();
    reload();
    setInterval(update, 10_000);
    let data = await (await fetch("?json")).json();
    init("ir_speeds", data.conf.ir_speeds);
    init("hood_speeds", data.conf.hood_speeds);
});
window.addEventListener("unload", () => {});
</script>
